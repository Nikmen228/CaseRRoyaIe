<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Case Royale</title>
    <!-- Подключаем Tailwind CSS для стилей -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Подключаем скрипт Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #181c21);
            --text-color: var(--tg-theme-text-color, #ffffff);
            --hint-color: var(--tg-theme-hint-color, #aaaaaa);
            --button-color: var(--tg-theme-button-color, #5288c1);
            --button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --secondary-bg-color: var(--tg-theme-secondary-bg-color, #2a2d32);
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 1rem;
        }
        .main-button { background-color: var(--button-color); color: var(--button-text-color); }
        .sell-button { background-color: #4caf50; color: white; }
        .card { background-color: var(--secondary-bg-color); }
        .store-card {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .store-card:hover {
            transform: scale(1.03);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        #roulette-modal { background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); }
        #roulette-line { left: 50%; width: 4px; background: linear-gradient(rgba(255,255,255,0), var(--button-text-color), rgba(255,255,255,0)); transform: translateX(-50%); }
        .roulette-item { width: 120px; height: 120px; }
        .weapon-icon, .case-icon { width: 48px; height: 48px; }
        .rarity-Common { background-color: #3d424b; }
        .rarity-Uncommon { background-color: #4a6a8b; }
        .rarity-Rare { background-color: #5d4a8b; }
        .rarity-Mythical { background-color: #8b4a78; }
        .rarity-Legendary { background-color: #a44e4e; }
        .rarity-Ancient { background-color: #daa520; }
        #wheel-canvas { transition: transform 7s cubic-bezier(0.2, 0.9, 0.1, 1); }
        .wheel-marker { width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-top: 30px solid var(--button-color); position: absolute; top: -10px; left: 50%; transform: translateX(-50%); }
        input[type="number"], select { background-color: var(--secondary-bg-color); border: 1px solid var(--hint-color); color: var(--text-color); }

        /* Анимации для обратной связи */
        @keyframes flash-green {
            0%, 100% { background-color: var(--secondary-bg-color); }
            50% { background-color: rgba(76, 175, 80, 0.3); }
        }
        @keyframes flash-red {
            0%, 100% { background-color: var(--secondary-bg-color); }
            50% { background-color: rgba(244, 67, 54, 0.3); }
        }
        .flash-green { animation: flash-green 0.6s ease-out; }
        .flash-red { animation: flash-red 0.6s ease-out; }
    </style>
</head>
<body class="antialiased">

    <!-- Основной контент -->
    <div id="main-content" class="w-full max-w-lg mx-auto">
        <header id="header-card" class="text-center mb-6 p-4 rounded-xl card transition-colors duration-300">
            <h1 class="text-3xl font-bold">Case Royale</h1>
            <p id="user-greeting" class="text-lg" style="color: var(--hint-color);"></p>
            <div class="text-2xl font-bold mt-2">Баланс: <span id="balance-display">$0.00</span></div>
        </header>

        <!-- Навигация -->
        <div class="grid grid-cols-3 gap-2 mb-6">
            <button onclick="switchTab('cases')" id="tab-cases" class="p-3 rounded-lg font-semibold main-button">Магазин</button>
            <button onclick="switchTab('inventory')" id="tab-inventory" class="p-3 rounded-lg font-semibold card">Инвентарь</button>
            <button onclick="switchTab('wheel')" id="tab-wheel" class="p-3 rounded-lg font-semibold card">Колесо</button>
        </div>

        <!-- ВКЛАДКА КЕЙСЫ (МАГАЗИН) -->
        <div id="content-cases" class="space-y-4"></div>
        
        <!-- ВКЛАДКА ИНВЕНТАРЬ -->
        <div id="content-inventory" class="hidden space-y-6">
            <div>
                <h2 class="text-xl font-bold mb-3">Мои кейсы</h2>
                <div id="inventory-cases-list" class="space-y-2"></div>
                <p id="inventory-cases-empty" class="text-center p-8 card rounded-xl" style="color: var(--hint-color);">У вас нет кейсов.</p>
            </div>
             <div>
                <h2 class="text-xl font-bold mb-3">Мои скины</h2>
                <div id="inventory-skins-list" class="space-y-2"></div>
                <p id="inventory-skins-empty" class="text-center p-8 card rounded-xl" style="color: var(--hint-color);">У вас нет скинов.</p>
            </div>
        </div>

        <!-- ВКЛАДКА КОЛЕСО ФОРТУНЫ -->
        <div id="content-wheel" class="hidden text-center card p-6 rounded-xl">
             <h2 class="text-2xl font-bold mb-4">Колесо Фортуны</h2>
             <div class="relative inline-block mb-4">
                 <canvas id="wheel-canvas" width="300" height="300"></canvas>
                 <div class="wheel-marker"></div>
             </div>
             <div class="my-4">
                 <label>Сумма ставки:</label>
                 <input type="number" id="money-bet-input" value="100" min="1" class="w-full p-2 rounded-lg text-center mt-1">
             </div>
             <button id="spin-button" onclick="spinTheWheel()" class="main-button font-bold py-3 px-8 rounded-lg text-lg w-full">Крутить!</button>
        </div>
    </div>

    <!-- Модальное окно с рулеткой для кейсов -->
    <div id="roulette-modal" class="fixed inset-0 z-50 flex-col items-center justify-center p-4 hidden">
        <div class="w-full max-w-lg mx-auto">
            <h2 id="modal-title" class="text-2xl font-bold text-center mb-4"></h2>
            <div class="relative overflow-hidden border-y-2" id="roulette-container" style="border-color: var(--button-color);">
                <div id="roulette-spinner" class="flex" style="transition: transform 5s cubic-bezier(0.2, 0.8, 0.2, 1);"></div>
                <div id="roulette-line" class="absolute top-0 bottom-0"></div>
            </div>
            <div id="result-display" class="text-center mt-6 hidden">
                <h3 class="text-xl font-bold">Вам выпало:</h3>
                <p id="result-item-name" class="text-3xl font-bold"></p>
                <p id="result-item-price" class="text-lg" style="color: var(--hint-color);"></p>
                <button onclick="closeModal()" class="main-button font-bold py-2 px-6 rounded-lg mt-4">Отлично!</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // --- ГЛОБАЛЬНОЕ СОСТОЯНИЕ И ДАННЫЕ ИГРЫ ---
        let state = { balance: 2500, items: [], cases: {} };

        const CASE_RARITIES = {
            Common: { name: 'Обычный', color: '#B0C4DE' },
            Uncommon: { name: 'Необычный', color: '#5D9CEB' },
            Rare: { name: 'Редкий', color: '#4B69FF' },
            Mythical: { name: 'Мифический', color: '#8847FF' },
            Legendary: { name: 'Легендарный', color: '#D32CE6' }
        };
        
        const WEAPON_ICONS = {
            pistol: `<svg class="weapon-icon" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M54 30H46V22C46 19.7909 44.2091 18 42 18H28C25.7909 18 24 19.7909 24 22V36H12C10.8954 36 10 36.8954 10 38V46C10 47.1046 10.8954 48 12 48H24V50C24 52.2091 25.7909 54 28 54H42C44.2091 54 46 52.2091 46 50V38H54C55.1046 38 56 37.1046 56 36V32C56 30.8954 55.1046 30 54 30Z" stroke="currentColor" stroke-width="4"/></svg>`,
            smg: `<svg class="weapon-icon" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M54 24V18H46M46 18L10 18V24M46 18L38 24M10 24H34M10 24V40H52V24M34 24V40M44 40V50H54V40" stroke="currentColor" stroke-width="4"/></svg>`,
            rifle: `<svg class="weapon-icon" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M58 14L34 14L28 22L8 22L8 30L30 30M58 14V22H48L42 30H30M58 14L48 8M30 30V38H36L42 46H50V38H58V30H42" stroke="currentColor" stroke-width="4"/></svg>`,
            sniper: `<svg class="weapon-icon" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8 32L58 32M48 24H58M48 40H58M8 32L24 20V44L8 32Z" stroke="currentColor" stroke-width="4"/><path d="M26 18L32 12" stroke="currentColor" stroke-width="4"/><path d="M38 18L44 12" stroke="currentColor" stroke-width="4"/></svg>`,
            knife: `<svg class="weapon-icon" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M56 38C56 38 38.8 44.4 26 32C13.2 19.6 26 8 26 8L40 22L56 38Z" stroke="currentColor" stroke-width="4"/><path d="M18 42L32 28" stroke="currentColor" stroke-width="4"/><path d="M22 48H12V38" stroke="currentColor" stroke-width="4"/></svg>`,
            default: `<svg class="weapon-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 22H15C20 22 22 20 22 15V9C22 4 20 2 15 2H9C4 2 2 4 2 9V15C2 20 4 22 9 22Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M9.75 12H14.25" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`
        };

        const CASE_ICONS = {
            Common: `<svg class="case-icon" viewBox="0 0 24 24"><rect x="3" y="6" width="18" height="12" rx="2" stroke="currentColor" fill="none" stroke-width="2"/></svg>`,
            Uncommon: `<svg class="case-icon" viewBox="0 0 24 24"><rect x="3" y="6" width="18" height="12" rx="2" stroke="currentColor" fill="none" stroke-width="2"/><line x1="9" y1="12" x2="15" y2="12" stroke="currentColor" stroke-width="2"/></svg>`,
            Rare: `<svg class="case-icon" viewBox="0 0 24 24"><rect x="3" y="6" width="18" height="12" rx="2" stroke="currentColor" fill="none" stroke-width="2"/><path d="M9 10 L15 10 M9 14 L15 14" stroke="currentColor" stroke-width="2"/></svg>`,
            Mythical: `<svg class="case-icon" viewBox="0 0 24 24"><rect x="3" y="6" width="18" height="12" rx="2" stroke="currentColor" fill="none" stroke-width="2"/><path d="M12 9 L15 12 L12 15 L9 12 Z" stroke="currentColor" fill="none" stroke-width="2"/></svg>`,
            Legendary: `<svg class="case-icon" viewBox="0 0 24 24"><rect x="3" y="6" width="18" height="12" rx="2" stroke="currentColor" fill="none" stroke-width="2"/><path d="M12 8 L14 11 L12 14 L10 11 Z" stroke="currentColor" fill="currentColor"/><path d="M12 11 L14 14 L12 17 L10 14 Z" stroke="currentColor" fill="none" stroke-width="1.5"/></svg>`,
        };
        
        const CASES_DATA = {
            common_case: { 
                name: 'Кейс "Призма"', 
                price: 100, 
                rarity: 'Common', 
                items: [
                    {name: 'P250 | Защитная окраска', rarity: 'Uncommon', price: 15},
                    {name: 'UMP-45 | Лунная ночь', rarity: 'Uncommon', price: 20},
                    {name: 'Five-Seven | Апельсиновая корка', rarity: 'Rare', price: 75},
                    {name: 'M4A4 | Городская DDPAT', rarity: 'Rare', price: 90},
                    {name: 'Glock-18 | Водяной', rarity: 'Mythical', price: 150},
                    {name: 'AWP | Африканская сетка', rarity: 'Legendary', price: 200},
                ]
            },
            uncommon_case: { 
                name: 'Кейс "Горизонт"', 
                price: 250, 
                rarity: 'Uncommon', 
                items: [
                    {name: 'Glock-18 | Призраки', rarity: 'Rare', price: 60},
                    {name: 'Tec-9 | Исаак', rarity: 'Rare', price: 80},
                    {name: 'M4A1-S | Сайрекс', rarity: 'Mythical', price: 300},
                    {name: 'AK-47 | Картель', rarity: 'Mythical', price: 450},
                    {name: 'AWP | Неонуар', rarity: 'Legendary', price: 800},
                ]
            },
            rare_case: { 
                name: 'Кейс "Разлом"', 
                price: 750, 
                rarity: 'Rare', 
                items: [
                    {name: 'P250 | Покоритель', rarity: 'Rare', price: 120},
                    {name: 'AK-47 | Элитное снаряжение', rarity: 'Mythical', price: 500},
                    {name: 'AWP | Азимов', rarity: 'Legendary', price: 1500},
                    {name: 'M4A4 | Вой', rarity: 'Ancient', price: 3000},
                ]
            },
            mythical_case: { 
                name: 'Кейс "Гидра"', 
                price: 2000, 
                rarity: 'Mythical', 
                items: [
                    {name: 'M4A4 | Неонуар', rarity: 'Mythical', price: 1200},
                    {name: 'Galil AR | Сахарные грёзы', rarity: 'Mythical', price: 1500},
                    {name: 'AWP | История о драконе', rarity: 'Legendary', price: 5000},
                    {name: 'Спортивные перчатки | Порок', rarity: 'Ancient', price: 7500},
                ]
            },
            legendary_case: { 
                name: 'Кейс "Браво"', 
                price: 5000, 
                rarity: 'Legendary', 
                items: [
                    {name: 'AK-47 | Огненный змей', rarity: 'Legendary', price: 4000},
                    {name: 'AWP | Медуза', rarity: 'Legendary', price: 6000},
                    {name: 'Нож-бабочка | Градиент', rarity: 'Ancient', price: 10000},
                ]
            }
        };
        
        const WHEEL_SECTORS = [
            { label: 'x0', multiplier: 0, color: '#f44336' }, 
            { label: 'x2', multiplier: 2, color: '#4caf50' }, 
            { label: 'x0.5', multiplier: 0.5, color: '#ff9800' },
            { label: 'x0', multiplier: 0, color: '#f44336' }, 
            { label: 'x0.5', multiplier: 0.5, color: '#ff9800' },
            { label: 'x3', multiplier: 3, color: '#8e24aa' },
            { label: 'x0', multiplier: 0, color: '#f44336' }, 
            { label: 'x0.5', multiplier: 0.5, color: '#ff9800' },
        ];
        
        // --- ЭЛЕМЕНТЫ DOM ---
        const headerCard = document.getElementById('header-card');
        const balanceDisplay = document.getElementById('balance-display');
        const inventoryCasesList = document.getElementById('inventory-cases-list');
        const inventoryCasesEmpty = document.getElementById('inventory-cases-empty');
        const inventorySkinsList = document.getElementById('inventory-skins-list');
        const inventorySkinsEmpty = document.getElementById('inventory-skins-empty');
        const storeContainer = document.getElementById('content-cases');
        
        // --- УПРАВЛЕНИЕ СОСТОЯНИЕМ И UI ---
        function loadState() { const saved = localStorage.getItem('caseRoyaleState'); if(saved) state = JSON.parse(saved); updateUI(); }
        function saveState() { localStorage.setItem('caseRoyaleState', JSON.stringify(state)); }

        function updateUI() {
            balanceDisplay.textContent = `$${state.balance.toFixed(2)}`;
            
            const hasSkins = state.items.length > 0;
            inventorySkinsEmpty.style.display = hasSkins ? 'none' : 'block';
            inventorySkinsList.style.display = hasSkins ? 'block' : 'none';
            if(hasSkins) {
                inventorySkinsList.innerHTML = state.items.map((item, index) => {
                    const icon = WEAPON_ICONS[getWeaponType(item.name)] || WEAPON_ICONS.default;
                    return `<div class="card p-3 rounded-lg flex justify-between items-center gap-4">
                        <div class="flex items-center gap-3"> ${icon} <span class="font-semibold">${item.name}</span> </div>
                        <button onclick="sellItem(${index})" class="sell-button font-bold py-2 px-4 rounded-lg">$${item.price.toFixed(2)}</button>
                    </div>`;
                }).join('');
            }

            const ownedCaseIds = Object.keys(state.cases).filter(id => state.cases[id] > 0);
            const hasCases = ownedCaseIds.length > 0;
            inventoryCasesEmpty.style.display = hasCases ? 'none' : 'block';
            inventoryCasesList.style.display = hasCases ? 'block' : 'none';
            if(hasCases) {
                inventoryCasesList.innerHTML = ownedCaseIds.map(id => {
                    const caseData = CASES_DATA[id];
                    const rarityData = CASE_RARITIES[caseData.rarity];
                    const icon = CASE_ICONS[caseData.rarity];
                    return `<div class="card p-3 rounded-lg flex justify-between items-center gap-4">
                        <div class="flex items-center gap-3">
                            <div style="color: ${rarityData.color}">${icon}</div>
                            <div>
                                <span class="font-semibold">${caseData.name}</span>
                                <small class="block" style="color: ${rarityData.color};">x${state.cases[id]}</small>
                            </div>
                        </div>
                        <button onclick="prepareAndOpenCase('${id}')" class="main-button font-bold py-2 px-4 rounded-lg">Открыть</button>
                    </div>`;
                }).join('');
            }
        }

        function renderStore() {
            storeContainer.innerHTML = Object.entries(CASES_DATA).map(([id, caseData]) => {
                const rarityData = CASE_RARITIES[caseData.rarity];
                return `<div class="card store-card p-4 rounded-xl shadow-lg flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-semibold">${caseData.name}</h2>
                        <p class="text-sm font-bold" style="color: ${rarityData.color};">${rarityData.name}</p>
                        <p class="text-sm" style="color: var(--hint-color);">$${caseData.price.toFixed(2)}</p>
                    </div>
                    <button onclick="buyCase('${id}')" class="main-button font-bold py-2 px-4 rounded-lg">Купить</button>
                </div>`;
            }).join('');
        }

        // --- ЛОГИКА ---
        function sellItem(index) {
            const item = state.items[index];
            state.balance += item.price;
            state.items.splice(index, 1);
            
            headerCard.classList.remove('flash-green', 'flash-red');
            void headerCard.offsetWidth;
            headerCard.classList.add('flash-green');

            tg.HapticFeedback.notificationOccurred('success');
            saveState();
            updateUI();
        }

        function buyCase(caseId) {
            const caseData = CASES_DATA[caseId];
            headerCard.classList.remove('flash-green', 'flash-red');
            void headerCard.offsetWidth; 

            if (state.balance < caseData.price) {
                tg.HapticFeedback.notificationOccurred('error');
                headerCard.classList.add('flash-red');
                return;
            }
            state.balance -= caseData.price;
            state.cases[caseId] = (state.cases[caseId] || 0) + 1;
            tg.HapticFeedback.notificationOccurred('success');
            headerCard.classList.add('flash-green');
            saveState();
            updateUI();
        }
        
        function prepareAndOpenCase(caseId) {
            if(!state.cases[caseId] || state.cases[caseId] <= 0) {
                tg.HapticFeedback.notificationOccurred('error');
                return;
            }
            state.cases[caseId]--;
            saveState();
            updateUI();

            const caseData = CASES_DATA[caseId];
            const modal = document.getElementById('roulette-modal');
            modal.querySelector('#modal-title').textContent = `Открытие: ${caseData.name}`;
            const spinner = modal.querySelector('#roulette-spinner');
            const winningItem = openCaseLogic(caseId);
            let rouletteItems = Array.from({length: 50}, () => caseData.items[Math.floor(Math.random() * caseData.items.length)]);
            rouletteItems[45] = winningItem;

            spinner.innerHTML = rouletteItems.map(item => {
                const icon = WEAPON_ICONS[getWeaponType(item.name)] || WEAPON_ICONS.default;
                return `<div class="roulette-item rarity-${item.rarity} flex-shrink-0 flex flex-col justify-center items-center p-2 text-white text-center">
                    ${icon}
                    <div class="font-semibold text-xs text-shadow">${item.name}</div>
                </div>`;
            }).join('');
            
            modal.classList.remove('hidden'); modal.classList.add('flex');
            
            setTimeout(() => {
                spinner.style.transition = 'none'; spinner.style.transform = 'translateX(0)';
                setTimeout(() => {
                    spinner.style.transition = 'transform 5s cubic-bezier(0.1, 0.7, 0.3, 1)';
                    const targetPosition = (45 * 120) - (modal.clientWidth / 2) + 60 + (Math.random() - 0.5) * 100;
                    spinner.style.transform = `translateX(-${targetPosition}px)`;
                }, 100);
            }, 10);

            setTimeout(() => {
                state.items.push(winningItem);
                saveState();
                updateUI();
                
                const resultDisplay = modal.querySelector('#result-display');
                resultDisplay.querySelector('#result-item-name').textContent = winningItem.name;
                resultDisplay.querySelector('#result-item-price').textContent = `Стоимость: $${winningItem.price.toFixed(2)}`;
                resultDisplay.classList.remove('hidden');
                tg.HapticFeedback.notificationOccurred('success');
            }, 5500);
        }
        
        // --- ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ И ИНИЦИАЛИЗАЦИЯ ---
        const getWeaponType = (name) => {
            const n = name.toLowerCase();
            if(n.includes('нож') || n.includes('knife') || n.includes('перчатки')) return 'knife';
            if(n.includes('awp') || n.includes('ssg') || n.includes('графит')) return 'sniper';
            if(n.includes('glock') || n.includes('p250') || n.includes('five-seven') || n.includes('tec-9') || n.includes('cz75')) return 'pistol';
            if(n.includes('mac-10') || n.includes('ump-45') || n.includes('pp-bizon')) return 'smg';
            if(n.includes('m4a4') || n.includes('m4a1-s') || n.includes('galil') || n.includes('scar-20') || n.includes('ak-47')) return 'rifle';
            return 'default';
        };
        const switchTab = (tabName) => {
            ['cases', 'inventory', 'wheel'].forEach(id => {
                document.getElementById(`content-${id}`).classList.add('hidden');
                document.getElementById(`tab-${id}`).classList.replace('main-button', 'card');
            });
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.replace('card', 'main-button');
        };
        const openCaseLogic = (caseId) => {
            const caseData = CASES_DATA[caseId];
            const chances = [{rarity: 'Common', chance: 0}, {rarity: 'Uncommon', chance: 79.92}, {rarity: 'Rare', chance: 15.98}, {rarity: 'Mythical', chance: 3.2}, {rarity: 'Legendary', chance: 0.64}, {rarity: 'Ancient', chance: 0.26}];
            const random = Math.random() * 100;
            let cumulative = 0;
            let chosenRarity = 'Uncommon';
            for (const r of chances) {
                cumulative += r.chance;
                if (random < cumulative) {
                    chosenRarity = r.rarity;
                    break;
                }
            }
            const itemsOfRarity = caseData.items.filter(item => item.rarity === chosenRarity);
            if (itemsOfRarity.length === 0) {
                 const availableRarities = caseData.items.map(i => i.rarity).filter((v, i, a) => a.indexOf(v) === i);
                 const fallbackRarity = availableRarities.sort((a,b) => chances.find(c=>c.rarity===b).chance - chances.find(c=>c.rarity===a).chance)[0];
                 const fallbackItems = caseData.items.filter(i => i.rarity === fallbackRarity);
                 return fallbackItems[Math.floor(Math.random() * fallbackItems.length)];
            }
            return itemsOfRarity[Math.floor(Math.random() * itemsOfRarity.length)];
        };
        const drawWheel = () => {
            const wheelCanvas = document.getElementById('wheel-canvas');
            const ctx = wheelCanvas.getContext('2d');
            const radius = wheelCanvas.width / 2;
            const arc = (2 * Math.PI) / WHEEL_SECTORS.length;
            
            ctx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);
            ctx.font = '20px Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            WHEEL_SECTORS.forEach((sector, i) => {
                const angle = i * arc;
                ctx.beginPath();
                ctx.fillStyle = sector.color;
                ctx.moveTo(radius, radius);
                ctx.arc(radius, radius, radius, angle, angle + arc);
                ctx.lineTo(radius, radius);
                ctx.fill();

                ctx.save();
                ctx.fillStyle = 'white';
                ctx.translate(radius + Math.cos(angle + arc / 2) * (radius - 40), radius + Math.sin(angle + arc / 2) * (radius - 40));
                ctx.rotate(angle + arc / 2 + Math.PI / 2);
                ctx.fillText(sector.label, 0, 0);
                ctx.restore();
            });
        };
        const spinTheWheel = () => {
            const spinButton = document.getElementById('spin-button');
            const moneyBetInput = document.getElementById('money-bet-input');
            const wheelCanvas = document.getElementById('wheel-canvas');

            let betValue = parseFloat(moneyBetInput.value);
            if (isNaN(betValue) || betValue <= 0) { alert("Неверная сумма ставки."); return; }
            if (state.balance < betValue) { alert("Недостаточно денег для ставки!"); return; }
            
            state.balance -= betValue;
            saveState(); 
            updateUI();
            
            spinButton.disabled = true; spinButton.textContent = 'Вращение...';
            
            const spinAngle = Math.random() * 360 + 360 * 7;
            wheelCanvas.style.transform = `rotate(${spinAngle}deg)`;
            
            setTimeout(() => {
                const degrees = spinAngle % 360;
                const arcSize = 360 / WHEEL_SECTORS.length;
                const winningIndex = Math.floor((360 - degrees + arcSize/2) % 360 / arcSize);
                const winningSector = WHEEL_SECTORS[winningIndex];

                const winnings = betValue * winningSector.multiplier;
                state.balance += winnings;
                
                saveState();
                updateUI();
                
                tg.HapticFeedback.notificationOccurred(winnings > betValue ? 'success' : (winnings < betValue ? 'error' : 'warning'));
                alert(`Выпало ${winningSector.label}! Ставка $${betValue.toFixed(2)}. Выигрыш: $${(winnings).toFixed(2)}.`);

                spinButton.disabled = false; spinButton.textContent = 'Крутить!';
            }, 7100);
        };
        const closeModal = () => { document.getElementById('roulette-modal').classList.add('hidden'); document.getElementById('roulette-modal').querySelector('#result-display').classList.add('hidden'); };

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('user-greeting').textContent = tg.initDataUnsafe.user ? `Привет, ${tg.initDataUnsafe.user.first_name}!` : 'Привет, игрок!';
            loadState();
            renderStore();
            drawWheel();
        });
    </script>
</body>
</html>

